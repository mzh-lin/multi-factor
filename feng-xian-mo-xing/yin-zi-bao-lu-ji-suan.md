# 因子暴露计算

在计算因子暴露的过程中，我们需要涉及到对因子数据的处理，主要的方式有以下几个类型：

* 异常值处理
* 缺失值处理
* 标准化处理
* 正态化处理
* 正交化处理

我们需要知道采取这些处理方式的目的和意义是什么，这样才能帮助我们更好的针对数据进行相应的处理。



**异常值处理**：这是一个异常值检测并修复的过程，在获取和计算数据的过程中，我们不可避免地会造成一些异常的数值。异常值会使得样本总体均值变化不大，但是标准差却放大了许多倍，这些异常值将对我们的因子回归造成很大的影响，使得我们的系数估计不再准确，从而影响因子在模型中的贡献。基于此，我们希望可以检测并修复这些异常值

**缺失值处理**：风险模型是由不同的风险因子为基础构成的，我们希望在截面回归的过程中保障每一只股票的因子值都是完整的，从而保障了不同因子的回归检测结果的可比性

**正态化处理**：只有当两个因子的分布都为近似正态分布时，基于均值-标准差标准化得到的zscore 才有可比性，否则样本偏度和峰度的影响会使得个股在某一个因子上的得分明显偏大或偏小，其在多因子中的效用被显著放大或缩小，也就是Scinto(2009)提到的Percential Ranking Problem。

**标准化处理**：出于因子比较和叠加的目的，我们希望因子可以满足N(0,1)的正态分布，标准化往往在正态化之后进行处理。

**正交化处理**：我们担心某一些因子与其他因子存在十分强的相关性时，我们希望通过正交化的方式对因子值进行提纯，使得因子间的相关性消除。

> 正交：$$E(XY)=0$$
>
> 不相关：$$E(XY)=E(X)E(Y)$$
>
> 因此当因子服从标准正态分布时，正交等价于不相关
>
> 同时一元线性回归的方式与施密特正交化的方式完全一致
>
> 而多元回归仅保证因变量与自变量垂直而无法保证自变量间的垂直关系



## 处理顺序

上述四个方法存在先后顺序，不同的顺序将导致因子得分发生很大的变化，因此如何选择顺序将是一个重要的问题。

我们目前的做法是：**异常值-缺失值-正态化-标准化**-**正交化**

原因在于，异常值将会影响到行业或是全市场因子的均值，这对我们进行缺失值填充有很重要的影响，同时他会影响标准化中样本方差的大小，因此他需要被放置在首位处理。通过对缺失值的处理，我们可以更好的针对完整的因子分布进行正态化处理，因此它被放置于第二位。正态化和标准化的顺序相对固定。

>  正交化的顺序存疑，但是正交化希望维持因子标准正态分布的假设，他需要放在最后。



## 去极值

较为传统去极值的方法有3 倍标准差法和中位数法。在BARRA 的风险模型中，普遍采用3 倍标准差法，但是我们研究发现，3 倍标准差法在处理分布偏度较大的因子截面时，仍然会产生异常结果影响回归方程的稳定性，因此国泰君安推荐使用中位数法剔除因子异常值。

### 中位数（MAD)法

对于一个截面的样本$$x_i,i=1,2,\dots,n$$，首先求中位数, $$x_{median}=median(x_i)$$，然后求所有样本点距离$$x_{median}$$的中位数, $$MAD = median(x_i-x_{median})$$. 将超出$$x_{median}\pm5MAD$$的数据调整到$$x_{median}\pm5MAD$$。

> 如果样本满足正态分布，且数据量较大，可以证明$$\sigma \approx  1.483 MAD$$, 则3倍以上的数据作为异常值。和均值标准差方法比，中位数和MAD 的计算不受极端异常值的影响，结果更加稳健。



### 经过偏度调整的Boxplot 法

#### 原Boxplot法

Boxplot 法由Turkey(1977)年提出, 是一种经验处理方法，假设$$Q_1$$和$$Q_3$$分别为数据从小到大排列的25%和75%分位数，记 $$IQR=Q_3-Q_1$$, 把$$(-\infty,Q_1-3\times IQR)\cup(Q_3+3\times IQR)$$ 区间里的数据标识为异常点。分位数也是稳健统计量，因此Boxplot 方法对极值不敏感。**但如果样本数据正偏严重，且右尾分布明显偏厚时，Boxplot 方法会把过多的数据划分为异常数据。**对此我们进行偏度调整。



#### 偏度调整Boxplot法

首先样本偏度定义采用了Brys(2004)提出的[MedCouple](http://www.statsmodels.org/stable/generated/statsmodels.stats.stattools.medcouple.html?highlight=medcouple#statsmodels.stats.stattools.medcouple) 方法：
$$
\begin{align*}
md=&median(x_i,i=1,2,\cdots,n)\\
mc=&median(\frac{(x_i-md)-(md-x_j)}{x_i-x_j},x_i>=md \&x_j<=md )
\end{align*}
$$
然后再给出了经过偏度调整Boxplot 方法上下限:
$$
\begin{align*}
L=\left\{\begin{array}{rcl}
&Q_1-1.5*exp(-3.5*mc)*IQR& if \ \  mc\geq0\\
&Q_1-1.5*exp(-4*mc)*IQR& if\ \  mc<0\\
\end{array} \right.\\
U=\left\{\begin{array}{rcl}
&Q_3+1.5*exp(-4*mc)*IQR& if\ \  mc\geq0\\
&Q_3+1.5*exp(-3.5*mc)*IQR & if\ \  mc<0\\
\end{array} \right.
\end{align*}
$$
区间$$(-\infty,L)\cup(U,\infty)$$里的数据被定义为异常数据。和原始Boxplot 方法相比，当样本数据分布右偏时，此法会提升正常数据区间上限的数值；样本数据左偏时，则会降低正常数据区间下限的数值。Hubert & Vandervieren(2007)仿真生成了不同偏度分布的数据样本，并在其中人为加入一些异常数据，发现调整后Boxplot 方法对异常数据的识别能力比传统方法要强很多。



> 这些异常值侦测方法都是针对单变量的，而我们实际做选股模型往往会用到多个因子数据，多个一维的正常数据组合在一起可能变成一个高维的异常数据。例如，10 岁是一个正常年龄，180cm 是一个正常身高，但如果组合在一起10 岁小孩180cm 身高则会变成一个异常数据。因此除了单变量的异常值侦测，理论上也需要考察多个因子组合在一起后的高维异常值，不过在做高维数据分析时，需要填充单维度上的缺省数据，而且高维分析很多基于高维联合正态分布假设，有必要先做数据变化再来做异常值分析，具体方法可以参考Aggarwa（l 2001）。



## 缺失值处理

一些券商常见的做法如下：

#### 小类因子缺失

如果小类因子缺失，不做处理，在合成大类因子时，将有值的小类因子权重按比例调整到和为1，再计算大类因子。但是如果大类因子下的所有小类因子均没有值则大类因子缺失。

#### 大类因子缺失

针对**财务类因子缺失**，如EarningsYield,Leverage等，按行业平均进行填值；

针对**市场类因子缺失**，如Momentum, Liquidity等，按回归的方式填值：若A因子缺失，则将A作为因变量，其他所有的因子作为自变量进行回归，然后用回归结果来拟合A因子的暴露。原因在于我们认为行业、市值或者其他属性相似的股票会有相似的因子暴露。



### 目前的想法

我们认为行业、市值或者其他属性相似的股票会有相似的因子暴露。所以我们希望用行业的均值（中位数）来填充缺失值。



## 正态化

把非正态数据转换为正态数据通常有取对数、开根号、求倒数等方法，这些都可以归为Box-Cox
变换，而我们希望可以利用Box-Cox变换使得因子的分布更加拟合正态分布。

### Box-Cox 变换

[Box-Cox](https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.boxcox.html)是一个常见的正态变换方式，Box-Cox的主要形式为：
$$
\begin{align*}
L=\left\{\begin{array}{rcl}
&\frac{(x^\lambda-1)}{\lambda}& if \ \  \lambda\neq0\\
&log(x)& if\ \  \lambda=0\\
\end{array} \right.\\
\end{align*}
$$
参数$$\lambda$$可以通过极大似然法做估计（Box & Cox 1964）。不过Box-Cox 变换并非万能，变换后的数据仍然可能不满足正态分布，被统计检验拒绝，但是这种变换得到的数据分布往往都有明显的对称性，与正态分布的相似性更高。另外，Box-Cox 变换针对的是大于零的正数数据，如果$$x<0$$,通常有两种做法,一种是给$$x$$加上一个数值$$\mu$$，使得序列$$x+\mu$$为正，$$\lambda$$和$$\mu$$可以都做为参数，通过极大似然方法求解。另一种是Yeo & Johnson (2000)的做法，对大于零和小于零的数采取不同的幂数变化。

> 目前我们采用减去最小值的方式保证$$x$$始终大于0

针对$$\lambda$$的选择，东方证券提出自己的观点，选股因子数据的复杂之处在于它同时具备时间序列和横截面两个维度的变化，如果把数据正态转换当成一个纯粹的数学问题，每个横截面上都用极大似然方法估算一个最优的$$\lambda$$，会发现有的选股因子的$$\lambda$$数值变化非常之大，频繁剧烈变换的参数可能会对结果产生负面影响，变换后因子的经济含义也更加难以解释，所以他们认为把因子数据正态变换当成一个单纯数学问题的方法不可取。

个人认为，在对截面$$\lambda$$进行极大似然估计时，记录$$\lambda$$的取值，在变换最后比对$$\lambda$$的极差来判断$$\lambda$$的变化幅度从而提醒时候要进行Box-Cox变化。



## 标准化

在BARRA 的风险模型中，采用根号市值加权的标准正态法，在一定程度上剔除了市值的影响，原因是BARRA认为一个完全分散的指数是不存在风险暴露的，而大部分指数是市值加权的，因此我们希望我们的因子也是市值加权均值为0.但是这样的方法会造成标准化因子截面的均值不等于0，这在之后的股票组合权重优化的风险敞口设置时会产生一定的偏差，考虑到这点，我们仅采用简单的标准正态法，即：

$$
d_{nl}=\frac{d_{nl}^{raw}-\mu_l}{\sigma_l}
$$

其中，$$d_{nl}$$为标准化因子序列，$$d_{nl}^{raw}$$为原始因子序列，$$\mu_l$$为$$d_{nl}^{raw}$$算数平均值，$$\sigma_l$$为$$d_{nl}^{raw}$$标准差

